> [!问题1]
> 求极限$$\lim_{n\to +\infty}\sum_{i\leq n}\sum_{j\leq 2n}\frac{2}{n^2}\left\lfloor\frac{2i+j}{n}\right\rfloor$$

### 1. 一种常见的渐近分析的做法

#### 1.1 回顾一下对黎曼和的积分近似

参考[[黎曼和对积分的近似]]，对于一元黎曼可积的函数在闭区间$[a,b]$上做黎曼和，我们可以用黎曼积分进行逼近。即$$\frac{1}{n}\sum_{i\leq n}f(x_i^{*})=\int_{a}^{b}f(x)\,dx+o(1)$$其中$x_i^{*}$是对$[a,b]$的一种划分中小区间上的代表元。通常为了分析上的简单，我们会把区间$[a,b]$进行均匀地划分，然后我们会选择每个小区间的左端点或者右端点作为代表元。比如如果我们选择右端点的话$$x_{i}^{*}=a+i\frac{b-a}{n}$$有时候也会做一些小的调整，比如如果我们把某个区间均匀分为$2n$个小区间，那么此时代表元如果取右端点，那么就会是$t_i^{*}=a+i\frac{i(b-a)}{2n}$那么求和的上限也会改变，从而黎曼和的近似变成了$$\frac{1}{2n}\sum_{i\leq 2n}f(t_i^{*})=\int_{a}^{b}f(t)\,dt+o(1)$$那么对于二元函数在区间$[a,b]\times [c,d]$上的累次积分也是类似的：
$$\frac{1}{n^2}\sum_{j\le n}\sum_{i\leq n}g(x_i^{*},y_i^{*})=\int_{c}^d\int_{a}^{b}g(x,y)\,dx\,dy+o(1)$$

#### 1.2 解决一开始的问题

思路其实就是：

> [!想法]
> 如果一个和，看起来像一个黎曼和，那么我们只要找到其对应的函数，并用黎曼积分去近似它就好了。
> 
> 这里之所以说看起来像，而不是说本身就是一个黎曼和，是因为有时候，虽然一个和并不能算作是某个函数的黎曼和，但是误差并不超过问题要求的精度，那么我们可以配合利用[[利用已知的渐近结果求渐近展开的技巧]]同样达到目的。

那么我们现在的问题是:

> [!问题2]
> $$S_n:=\sum_{i\leq n}\sum_{j\leq 2n}\frac{2}{n^2}\left\lfloor\frac{2i+j}{n}\right\rfloor$$这个和，在$o(1)$的精度范围内，是否可以看成是一个黎曼和?

其实并不难看出来，这就是一个黎曼和。我们只需要稍微改写一下形式就能发现$$\begin{aligned}S_n &= \frac{2}{n}\sum_{i\leq n}\frac{2}{2n}\sum_{j\leq 2n}\left\lfloor\frac{2i}{n}+\frac{j}{n}\right\rfloor\\&=\int_{0}^{2}\int_{0}^{2}\left\lfloor x+y\right\rfloor \,dx\,dy+o(1)\\&= 6+o(1)\end{aligned}$$于是$S_n\to 6$.

稍微练习一下我们就能摸索出这其中的技巧：
1. 对于$i$,求和上限是$n$,求和下限是$1$，这意味着，如果这是关于变量$x$的积分，积分区间为$[a,b]$，那么这意味着我们要把区间$[a,b]$均匀分为$n$份，每个小区间长度为$\frac{(b-a)}{n}$。同时我们去找带有$a+\frac{i(b-a)}{n}$的被求和对象，我们找到了$\frac{2i}{n}$,一种合理的构造就是$$a=0,b-a=2\implies [a,b]=[0,2]$$
2. 同样的道理对$j$操作一遍，我们发现求和上限为$2n$,这意味着区间$[c,d]$被分为$2n$份，每一个区间长度为$\frac{d-c}{2n}$.并且我们去找被求和对象当中的$c+\frac{j(d-c)}{2n}$的对象，我们找到了$\frac{j}{n}$,于是一种合理的构造就是$$c=0,d-c=2$$
### 2. 一种更为有趣的做法

既然$S_n$是关于取整函数的和，那么我们有必要分析一下改取整函数$$h(i,j):=\left\lfloor\frac{2i+j}{n}\right\rfloor$$的取值范围了。

由于$i,j$的取值范围，我们直到$h$的取值只能是$E:=\{0,1,2,3,4\}$五种可能。那么按照[[分组求和]]的思路,我们可以把$S_n$重新改写为$$S_n=\frac{2}{n^2}\sum_{y\in E} y|h^{-1}(y)|$$也就是说：

> [!想法]
> 我们只要能在误差为$o(n^2)$的范围内估算出$h$这个函数的每个取值的在集合$\{1,\cdots,n\}\times\{1,\cdots,2n\}$当中的原像的元素的个数，那么我们就能得到$S_n$的极限。即我们需要搞清楚下面这个四边形图形内部及其边界上的整数格点的数目，误差范围在$o(n^2)$级别:$$\{(x,y)\in \{1,...,n\}\times\{1,...,2n\}:kn\leq  2x+y < (k+1)n\}$$其中$k=0,1,2,3$

#### 2.1 生成函数的办法

我们想到[[线性丢番图方程非负整数解的个数]]当中的问题，如果我们假设$$N_k(n):=\#\{(x,y)\in \{1,...,n\}\times\{1,...,2n\}:kn\leq  2x+y < (k+1)n\}$$那么我们可以把问题转换为一种限制了解的范围的线性丢番图方程的解的解的个数问题。假设$$p_{k,n}(m):=\#\{(x,y)\in \{1,...,n\}\times\{1,...,2n\}:2x+y= m\}$$那么实际上$$N_k(n)=\sum_{(k+1)n>m\geq kn}p_{k,n}(m)$$而求$r_{k,n}(m)$也就是求这样一个线性丢番图方程的解的个数。我们立刻想到可以参考[[线性丢番图方程非负整数解的个数]]当中第2,3节的做法，借助生成函数来完成计数问题。但是不同于之前的问题，此处解的范围是被限制起来了的。不过我们依旧可以利用生成函数来达到目的，不过需要稍微改变一下其中的细节。

考虑生成函数$$\begin{aligned}G(z):&=(z^2+\cdots+z^{2n})(z+z^2\cdots+z^{2n})\\&= z^3\frac{(1-z^{2n})^2}{(1-z)(1-z^2)}\\&=(z^3-2z^{2n+3}+z^{4n+3})\sum_{m\geq 0}A_mz^{m}\end{aligned}$$那么此生成函数的$m$次项系数可以表示为$$r(m-3)-2r(m-3-2n)+r(m-3-4n)$$其中$$r(x):=\begin{cases}\lfloor x/2\rfloor+1&x\geq 0\\0&\text{otherwise}\end{cases}$$
以下代码用于检查上述推导是否存在问题：

```wolfram
f[x_] := If[x > 0, Floor[(x)/2] + 1, 0]
n = 500;
m = 1541;
Table[If[2*x + y == m, 1, 0], {x, 1, n}, {y, 1, 2*n}] // 
  Flatten // Total
SeriesCoefficient[(
 z^3 (-1 + z^(2 n))^2)/((-1 + z) (-1 + z^2)), {z, 0, m}]
f[m - 3] - 2*f[m - 2*n - 3] + f[m - 4*n - 3]
```


#### 2.2 估计整点的个数

接下来我们来计算，每个部分的整数点的渐近结果
1. 首先当$m<n$的时候无需计算，因为$S_n=\frac{2}{n^2}\sum_{y\in E} y|h^{-1}(y)|$当中此时$y=0$,使得这一项对$S_n$的值不会有任何影响。
2. 当$n\leq m< 2n$的时候，$r(m-3-2n),r(m-3-4n)$都为0，那么实际上这一部分的整数点的个数为$$\begin{aligned}\sum_{2n\geq m>n}r(m-3)&=\sum_{2n> m\geq n}\left\lfloor \frac{m-3}{2}\right\rfloor+1\\&=\sum_{2n> m\geq n}\frac{m}{2}+O(1)\\&= \frac{3}{4}n^2+O(n)\end{aligned}$$
3. 当$2n\leq m< 3n$的时候,$r(m-3-4n)$为0,于是这部分的整点个数的估计为$$\begin{aligned}\sum_{3n> m\geq 2n}r(m-3)-2r(m-3-2n)&=\sum_{3n> m\geq 2n}\left\lfloor \frac{m-3}{2}\right\rfloor-2\sum_{3n> m\geq 2n}\left\lfloor \frac{m-2n-3}{2}\right\rfloor+O(n)\\&=\sum_{3n> m\geq 2n}\frac{m-2m+4n}{2}+O(n)\\&= \frac{3}{4}n^2+O(n)\end{aligned}$$
4. 当$3n\leq m<4n$的时候,同样的道理整个部分的整点个数估计为$$\begin{aligned}\sum_{3n> m\geq 2n}r(m-3)-2r(m-3-2n)+r(m-4n-3)&=\frac{1}{4}n^2+O(n)\end{aligned}$$
用于验证计算是否正确的代码：

```wolfram
n = 100000;
k=3
Sum[f[m - 3] - 2*f[m - 2*n - 3] + f[m - 4*n - 3], {m, k*n, (k+1)*n}]/n^2 //N
```


综上所述$$\begin{aligned}S_n&=\frac{2}{n^2}\sum_{y\in E} y|h^{-1}(y)|\\&=\frac{2}{n^2}\left(1\times \frac{3}{4}n^2+2\times \frac{3}{4}n^2+3\times \frac{1}{4}n^2+O(n)\right)\\&= 6+O\left(\frac{1}{n}\right)\end{aligned}$$
因此极限一定是6。

